<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据管理系统 - 控制台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- 引入认证验证模块 -->
    <script src="/auth/js/verify.js"></script>
    <!-- 引入数据导入模块 -->
    <script src="/public/js/import.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        danger: '#F53F3F',
                        success: '#00B42A',
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-database text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">数据管理系统</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <span id="userInfo" class="text-gray-600"></span>
                <button id="logoutBtn" class="text-gray-600 hover:text-primary">
                    <i class="fa fa-sign-out"></i> 退出
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <div class="mb-6 flex flex-wrap gap-4">
            <button id="refreshBtn" class="flex items-center px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                <i class="fa fa-refresh mr-2"></i> 刷新数据
            </button>
            
            <button id="addDataBtn" class="flex items-center px-4 py-2 bg-success text-white rounded-md hover:bg-success/90 transition-colors">
                <i class="fa fa-plus mr-2"></i> 添加数据
            </button>
            
            <div class="ml-auto">
                <label class="block text-sm font-medium text-gray-700 mb-1">批量上传数据</label>
                <input type="file" id="batchUpload" accept=".json" class="hidden">
                <label for="batchUpload" class="flex items-center px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors cursor-pointer">
                    <i class="fa fa-upload mr-2"></i> 选择JSON文件
                </label>
            </div>
        </div>
        
        <div id="uploadProgress" class="mb-6 hidden">
            <div class="text-sm text-gray-600 mb-1">上传进度: <span id="progressPercent">0%</span></div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progressBar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold">卫星任务数据</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">计划ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">开始时间</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">客户名称</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">卫星名称</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">测站名称</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">任务状态</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="8" class="px-6 py-10 text-center text-gray-500">
                                <i class="fa fa-spinner fa-spin mr-2"></i> 验证身份中...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 添加/编辑数据模态框 -->
    <div id="dataModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-lg font-semibold">添加数据</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="dataForm">
                <input type="hidden" id="dataId">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">计划ID</label>
                    <input type="text" id="planId" required 
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">开始时间</label>
                    <input type="datetime-local" id="startTime" required 
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">客户名称</label>
                    <input type="text" id="customerName" 
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">卫星名称</label>
                    <input type="text" id="satelliteName" 
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">测站名称</label>
                    <input type="text" id="stationName" 
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">任务状态</label>
                    <select id="taskStatus" 
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                        <option value="成功">成功</option>
                        <option value="失败">失败</option>
                        <option value="进行中">进行中</option>
                        <option value="未开始">未开始</option>
                    </select>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">任务类型</label>
                    <input type="text" id="taskType" 
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelBtn" 
                            class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors">
                        取消
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 使用AuthVerifier验证身份
            const user = await AuthVerifier.requireAuth();
            if (!user) {
                return; // 未通过验证，会自动跳转至登录页
            }
            
            // 显示用户信息
            document.getElementById('userInfo').textContent = `欢迎，${user.username}`;
            
            // DOM元素
            const dataTableBody = document.getElementById('dataTableBody');
            const refreshBtn = document.getElementById('refreshBtn');
            const addDataBtn = document.getElementById('addDataBtn');
            const dataModal = document.getElementById('dataModal');
            const closeModal = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const dataForm = document.getElementById('dataForm');
            const modalTitle = document.getElementById('modalTitle');
            const logoutBtn = document.getElementById('logoutBtn');
            const batchUpload = document.getElementById('batchUpload');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            
            // 获取当前令牌
            const token = AuthVerifier.getToken();
            
            // 加载数据
            async function loadData() {
                try {
                    dataTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-10 text-center text-gray-500">
                                <i class="fa fa-spinner fa-spin mr-2"></i> 加载数据中...
                            </td>
                        </tr>
                    `;
                    
                    const response = await fetch('/api/data', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('加载数据失败');
                    }
                    
                    const data = await response.json();
                    
                    if (data.length === 0) {
                        dataTableBody.innerHTML = `
                            <tr>
                                <td colspan="8" class="px-6 py-10 text-center text-gray-500">
                                    没有数据，请添加数据
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    // 渲染表格
                    dataTableBody.innerHTML = data.map(item => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${item.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${item.plan_id}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${new Date(item.start_time).toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${item.customer_name || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${item.satellite_name || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${item.station_name || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    ${item.task_status === '成功' ? 'bg-green-100 text-green-800' : 
                                      item.task_status === '失败' ? 'bg-red-100 text-red-800' :
                                      item.task_status === '进行中' ? 'bg-yellow-100 text-yellow-800' :
                                      'bg-gray-100 text-gray-800'}">
                                    ${item.task_status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="editData(${item.id})" class="text-primary hover:text-primary/80 mr-3">
                                    <i class="fa fa-pencil"></i> 编辑
                                </button>
                                <button onclick="deleteData(${item.id})" class="text-danger hover:text-danger/80">
                                    <i class="fa fa-trash"></i> 删除
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    
                } catch (error) {
                    dataTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-10 text-center text-red-500">
                                <i class="fa fa-exclamation-circle mr-2"></i> 加载数据失败: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
            
            // 编辑数据
            window.editData = async (id) => {
                try {
                    const response = await fetch(`/api/data/${id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('获取数据失败');
                    }
                    
                    const data = await response.json();
                    
                    // 填充表单
                    document.getElementById('dataId').value = data.id;
                    document.getElementById('planId').value = data.plan_id;
                    document.getElementById('startTime').value = new Date(data.start_time).toISOString().slice(0, 16);
                    document.getElementById('customerName').value = data.customer_name || '';
                    document.getElementById('satelliteName').value = data.satellite_name || '';
                    document.getElementById('stationName').value = data.station_name || '';
                    document.getElementById('taskStatus').value = data.task_status || '成功';
                    document.getElementById('taskType').value = data.task_type || '';
                    
                    modalTitle.textContent = '编辑数据';
                    dataModal.classList.remove('hidden');
                } catch (error) {
                    alert(`编辑失败: ${error.message}`);
                }
            };
            
            // 删除数据
            window.deleteData = async (id) => {
                if (!confirm('确定要删除这条数据吗？')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/data/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('删除失败');
                    }
                    
                    loadData();
                } catch (error) {
                    alert(`删除失败: ${error.message}`);
                }
            };
            
            // 事件监听
            refreshBtn.addEventListener('click', loadData);
            
            addDataBtn.addEventListener('click', () => {
                // 重置表单
                dataForm.reset();
                document.getElementById('dataId').value = '';
                document.getElementById('startTime').value = new Date().toISOString().slice(0, 16);
                modalTitle.textContent = '添加数据';
                dataModal.classList.remove('hidden');
            });
            
            closeModal.addEventListener('click', () => {
                dataModal.classList.add('hidden');
            });
            
            cancelBtn.addEventListener('click', () => {
                dataModal.classList.add('hidden');
            });
            
            dataForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const id = document.getElementById('dataId').value;
                const data = {
                    planId: document.getElementById('planId').value,
                    startTime: document.getElementById('startTime').value,
                    customerName: document.getElementById('customerName').value,
                    satelliteName: document.getElementById('satelliteName').value,
                    stationName: document.getElementById('stationName').value,
                    taskStatus: document.getElementById('taskStatus').value,
                    taskType: document.getElementById('taskType').value
                };
                
                try {
                    let url = '/api/data';
                    let method = 'POST';
                    
                    if (id) {
                        url = `/api/data/${id}`;
                        method = 'PUT';
                    }
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error('保存失败');
                    }
                    
                    dataModal.classList.add('hidden');
                    loadData();
                } catch (error) {
                    alert(`保存失败: ${error.message}`);
                }
            });
            
            // 使用AuthVerifier处理退出登录
            logoutBtn.addEventListener('click', () => {
                if (confirm('确定要退出登录吗？')) {
                    AuthVerifier.clearAuthData();
                    window.location.href = '/auth/login.html';
                }
            });
            
            // 批量上传数据（使用DataImporter模块）
            batchUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    // 显示进度条
                    uploadProgress.classList.remove('hidden');
                    progressBar.style.width = '0%';
                    progressPercent.textContent = '0%';
                    
                    // 使用DataImporter加载并验证数据
                    const rawData = await DataImporter.loadFromFile(file);
                    
                    // 上传所有数据
                    const result = await DataImporter.uploadAllChunks(
                        rawData, 
                        token,
                        (progress) => {
                            // 更新进度条
                            progressBar.style.width = `${progress}%`;
                            progressPercent.textContent = `${progress}%`;
                        }
                    );
                    
                    if (result.success) {
                        uploadProgress.classList.add('hidden');
                        alert(result.message);
                        loadData();
                    } else {
                        throw new Error(result.message);
                    }
                    
                    // 重置文件输入
                    batchUpload.value = '';
                } catch (error) {
                    console.error('上传失败:', error);
                    uploadProgress.classList.add('hidden');
                    alert(`上传失败: ${error.message}`);
                }
            });
            
            // 初始加载数据
            loadData();
        });
    </script>
</body>
</html>
